---
layout: post_layout
title: 主播周期性丢包导致卡顿问题定位
author: ruin
time: 2016年07月20日 星期三
location: 深圳
pulished: true
excerpt_separator: "```"
---

### 问题
有一主播反馈其发直播，观众观看时经常卡顿

### 定位过程
首先看直播团队提供的质量监控网站[http://avq.server.com/reportapp/](http://avq.server.com/reportapp/)
![avmonitor上行质量曲线](http://o97en6hsv.bkt.clouddn.com/%E5%B8%A6%E5%AE%BD%E9%99%90%E5%88%B6%E5%BC%95%E8%B5%B7%E5%91%A8%E6%9C%9F%E6%80%A7%E4%B8%A2%E5%8C%85.png)
可以看到上行丢包和上行码率呈极为规律的曲线，码率高时丢包也高，呈周期性波动
咨询直播团队的同事，推测这种应该是带宽限制了，码率一旦超过带宽就会丢包，我们配置的直播码率范围是600kbps到1200kbps，直播sdk根据丢包和延迟会在我们指定的码率范围内动态调整

如何证明确实是带宽不够引起的呢？
首先iphone的开发者模式可以模拟各种网络条件，其中我们可以指定带宽，自己模拟一把
![开发者模式设置带宽](http://o97en6hsv.bkt.clouddn.com/%E5%BC%80%E5%8F%91%E8%80%85%E6%A8%A1%E5%BC%8F%E8%AE%BE%E7%BD%AE%E5%B8%A6%E5%AE%BD.jpg)
这里我设置上行1000kbps，再发直播，能够完美复现以上曲线

我们想再看看主播的实际带宽是多少，百度了一下，找到这个[网速测试工具](http://wangsuceshi.51240.com/)。
在刚才开发者模式设置上行1000kbps情况下，实际跑一下测速，测速结果如下：
![测速结果](http://o97en6hsv.bkt.clouddn.com/%E7%BD%91%E9%80%9F%E6%B5%8B%E8%AF%95.jpg)
可以看到测速还是比较准确的。
让主播跑一下这个工具测速，果然实际带宽大约在1000kbps。

既然主播的带宽是1000kbps，如果配置码率范围在600至800kbps会怎样？我们按以上码率范围让主播试了一把，曲线如图：
![码率上限800的曲线](http://o97en6hsv.bkt.clouddn.com/%E7%A0%81%E7%8E%87%E4%B8%8A%E9%99%90800%E7%9A%84%E6%9B%B2%E7%BA%BF.png)
可以看到不丢包了，观众观看直播也很流畅了。当然码率降低会牺牲一些清晰度。

### 结论
经过以上定位过程，问题明确了：

1. 我们配置的动态码率范围是600~1200kbps，sdk内部会根据丢包和延迟动态调整码率。
2. 用户的带宽刚好介于我们的动态码率范围内，sdk动态码率算法对于这种情况的处理不够好，会形成周期性丢包。
3. 和直播的同事讨论，下个版本会对算法进行优化，目标是码率趋于一条稳定的曲线，不丢包。
4. 个人的建议有两点：1、现在反馈的周期太短，两秒无丢包的话，码率就增加，应当增加反馈周期；2、码率增加的粒度应当更细，轻微的丢包udt可以cover住，但是码率增加太快，丢包太多的话udt也保证不了。
5. sdk自适应码率算法优化之前，我们对带宽不足的主播配置较低的码率。
